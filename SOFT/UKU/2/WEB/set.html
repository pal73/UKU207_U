<!DOCTYPE html >
<html lang="ru">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Установки</title>
	<link href="uku.css" rel="stylesheet">
	<script src="jquery-1.7.min.js"></script>
	<script src="dict.js"></script>
	<script src="pal_decoder.js"></script>
	<script>
		var passwordFormIsPainted=0;
		var passwordFormDeniedIsPainted=0;
		var batTblIsPainted=0;
		var srcTblIsPainted=0;
		var invTblIsPainted=0;
		var bypasTblIsPainted=0;
		var numOfBat=0;
		var numOfSrc=0;
		var numOfInv=0;
		var numOfBypas=0;	
		var src_data= new Array(16);
		var isPainted=0;
	  
	  	$( function() {
			console.log("Страница загружена");
			var div = document.createElement('div');
			div.className = "alert alert-success";
			div.id="window1";
			div.innerHTML = '<span id = "span_pasw">Введите пароль</span><input type="password" class="large" name="PassWord" id="passWord"  autocomplete="off" maxlength="25" value=""><button id="pswBut" onclick="pswrdEntry(passWord.value)">Ввести</button>';
			main.appendChild(div);
	  	} );

		function isCheck(name) {
			var a="name='radio_input_2'";
			/*alert("selected: " + $('input[name="' + name + '"]:checked').val());
			alert("selected: " + $('input[name="' + name + '"]:checked').val());*/
		     output=$('input[name="' + name + '"]:checked').val();
		     return output;
		}

		function pswrdEntry(input) {
			/*cnter ++;*/
			/*$("#Data1").text(cnter);*/
			/*console.log("нажата кнопка " + input_);*/
			$.post("but.cgx",{ parol: input },function(){console.log("Пришел ответ на пароль")});
			console.log("Отправлен пароль");
		}
		function dataUpdate(){
			var data = {};
			$.getJSON( "set.cgx", data, success );
		}
		function button_enter_press(input) {
			var mainSelector=set_dict[input][4];
			var parametrSet="";
			var inp;
			var inpSelector;
			var mult=set_dict[input][3];

			if(mainSelector=="INTINPUT"){
				inpSelector="#text_input_"+input;
				inp=$(inpSelector).val();
				parametrSet=inp;
				if(mult=="INT/10")parametrSet=inp*10;
				else if(mult=="INT/100")parametrSet=inp*100;
				else if(mult=="INT/1000")parametrSet=inp*1000;
				/*parametrSet=inp;*/
			}
			else if(mainSelector=="STRINGINPUT"){
				inpSelector="#text_input_"+input;
				inp=$(inpSelector).val();
				parametrSet=pal_cyr_coder(inp);
			}
			else if(mainSelector=="RADIOINPUT"){
				inpSelector="radio_input_" + input;
				inp=isCheck(inpSelector);
				parametrSet=inp;
			}

			
			/*var xxx=pal_cyr_coder(input2);*/
			$.post("but.cgx",{ param: set_dict[input][7], value: parametrSet},function(){console.log("Пришел ответ на пароль")});
			console.log("Отправлен параметр");
			
		}

		function controlGenerator(num) {
			var output="";
			if(set_dict[num][4]=="INCDEC") {
				/*output = 	'<input value="-' + num + '" type="button" onclick="buttonPressing()" class = "btn">';
				output += 	'<input value="+' + num + '" type="button" onclick="alert(\'Клик+!\')" class = "btn">';*/
				output = 	'<button id="but' + num +'mi" style="width:50px"  value="-' + num + '" type="button" onclick="buttonPressing(this.id)" class = "btn"> - </button>';
				output += 	'<button id="but' + num +'pl" style="width:50px"  value="+' + num + '" type="button" onclick="buttonPressing(this.id,this.value)" class = "btn"> + </button>';
			}
			else if(set_dict[num][4]=="INTINPUT") {
				var mmult =1;
				if(set_dict[num][3]=="INT/10")mmult =10;
				output +=	'<input id="text_input_' + num + '" type="text" size="42">';
				output += 	'<button id="but_enter_' + num + '" style="width:50px margin: 0 10px" onclick="button_enter_press(' + num + ')">Ввести</button>';/*,' + mmult + '*/
			}
			else if(set_dict[num][4]=="STRINGINPUT") {
				output +=	'<input id="text_input_' + num + '" type="text" size="42">';
				output += 	'<button id="but_enter_' + num + '" style="width:50px margin: 0 10px" onclick="button_enter_press(' + num + ')">Ввести</button>';
			}
			else if(set_dict[num][4]=="RADIOINPUT") {
				numOfButtons = set_dict[num][6].length;
				for(var i=0; i<numOfButtons;i++){
					output +=	'<span><input name="radio_input_' + num + '" type="radio" value="' + i +'"> ' + set_dict[num][6][i]+'</span>';
				}
				output += 	'<button id="but_enter_' + num + '" style="width:50px margin: 0 10px" onclick="button_enter_press(' + num + ')">Ввести</button>';
			}


			return output;
		}

/*		function palDecoder(input) {
			var output = "",i=0;
		
        while (input[i]){
	        	if(input[i]=='^'){
	        		if(input[++i]=='X'){
	        			output+=palDict[input[i]+input[i+1]];
	        			i++;
	        			i++;
	        		}
	        		else {output += palDict[input[i]];
	        		i++;
	        		}
	        	}
	        	else {
	        		output +=input[i++];
	        	}
	        }
	        return output;
		}*/
	 	function success ( inputData ) {
			/*numOfBat=inputData.numOfBat;
			numOfSrc=inputData.numOfSrc;
			numOfInv=inputData.numOfInv;
			numOfBypas=inputData.numOfBypas;*/
			document.getElementById("dev_name").innerHTML=palDecoder(inputData.model);
			document.getElementById("dev_serial").innerHTML="S№"+palDecoder(inputData.serial);
			document.getElementById("dev_place").innerHTML=palDecoder(inputData.place);

			if(inputData.autorised=="DENIED"){
				if(passwordFormDeniedIsPainted==0){
					var span = document.createElement('div');
					span.innerHTML = '<span>Пароль неверный повторите попытку!</span>';
					span.id="span_denied";
					var div = document.getElementsByClassName("alert");
					window1.appendChild(span);
					passwordFormDeniedIsPainted=1;
  					setTimeout(function() {
    				span.parentNode.removeChild(span);
    				passwordFormDeniedIsPainted=0;
  					}, 3000);					
				}
			}
			else if(inputData.autorised=="ON") {

				var div = document.getElementsByClassName("alert");
				if(div[0]) div[0].parentNode.removeChild(div[0]);
				

				var numOfSets = inputData.numOfSet ;/*set_dict.length-1;*/
				var set = new Array(100);
				set[0] = inputData.s01.split(",");/*серийный номер*/ 
				set[1] = inputData.s02.split(",");/*расположение*/
				set[2] = inputData.s03.split(",");/*звуковая сигнализация*/
				set[3] = inputData.s04.split(",");/*параллельная работа источников*/
				set[4] = inputData.s05.split(",");/*автоматическое снятие сигнала аварий*/ 
				set[5] = inputData.s06.split(",");/*Umin.сети*/ 
				set[6] = inputData.s07.split(",");/*Umax.сети*/ 
				set[7] = inputData.s08.split(",");/*время ротации*/ 
				set[8] = inputData.s10.split(",");/*Imax*/  
				set[9] = inputData.s11.split(",");/*Imin*/
				set[12] = inputData.s14.split(",");/*Uб20*/  
				set[13] = inputData.s15.split(",");/*Uб0*/    
				set[10] = inputData.s12.split(",");/*Umax.ист*/  
				set[11] = inputData.s13.split(",");/*Umin.ист*/ 
				set[14] = inputData.s16.split(",");/*Uсигн*/
				set[15] = inputData.s17.split(",");/*Iзmax*/
				set[16] = inputData.s18.split(",");/*Tбатсигн*/
				set[17] = inputData.s19.split(",");/*Tбатмакс*/	
				set[18] = inputData.s20.split(",");/*Uвз*/
				set[19] = inputData.s21.split(",");/*Tвз*/
				set[20] = inputData.s22.split(",");/*tи.сигн*/
				set[21] = inputData.s23.split(",");/*tи.max*/
				set[22] = inputData.s24.split(",");/*TZAS*/
				set[23] = inputData.s25.split(",");/*APV1*/
				set[24] = inputData.s26.split(",");/*APV2*/
				set[25] = inputData.s27.split(",");/*APV2 период*/
				set[26] = inputData.s28.split(",");/*U0б*/
				set[27] = inputData.s29.split(",");/*Tбат*/
				set[28] = inputData.s30.split(",");/*Iкб*/
				set[29] = inputData.s31.split(",");/*год*/
				set[30] = inputData.s32.split(",");/*месяц*/
				set[31] = inputData.s33.split(",");/*день*/
				set[32] = inputData.s34.split(",");/*час*/
				set[33] = inputData.s35.split(",");/*минуты*/
				set[34] = inputData.s36.split(",");/*секунды*/
				/*set[35] = inputData.s37.split(",");/*Iкб*/				  

				  
				console.log("Данные получены");

			  	if(isPainted==0) {
			  		$("#setTable").remove(); 
					var myTable = '' ;
					myTable += '<table id="setTable" width="100%" style="table-layout: fixed" cellspacing=0 cellpadding=2 border=1>' ;
					myTable += '<col width="250" valign="middle" align="left">' ;
			   		myTable += '<col width="45%" valign="middle" text-align="right" class = "abc">' ;
			   		myTable += '<col width="55%" valign="middle" align="justify">' ;
					myTable +=  "<thead>" ;
					myTable +=   "<tr>";
					myTable +=    "<th>"     + "Параметр33" +       "</th>";
					myTable +=    "<th>"     + "Значение" +       "</th>";
					myTable +=    "<th>"     + "Изменение" +       "</th>";
					myTable +=   "</tr>" ;
					myTable +=  "</thead>" ;
					myTable +=  "<tbody>" ;

					for (var i = 0; i < numOfSets; i++) {
						var nameOfParam=set_dict[i][0];
						var titleOfParam=set_dict[i][1];
						var unit=set_dict[i][2];
						var valueOfParam;
						if(set_dict[i][8]=="s00"){
							myTable += '<tr>';
						    myTable += '<td text-align="right">';
						    myTable += nameOfParam;
						    myTable += "</td>";
						    myTable += "</tr>";
						}
						else{
							if(set_dict[i][5]=="DIAP"){
								var _min=set_dict[i][6][0];
								var _max=set_dict[i][6][1];
								if(set_dict[i][3]=="INT/10"){
									_min/=10;
									_max/=10;
								}
								else if(set_dict[i][3]=="INT/100"){
									_min/=100;
									_max/=100;
								} 
								titleOfParam+=" Предельные значения " + _min + unit + " - " + _max + unit + ".";
							}
							else if(set_dict[i][5]=="MAXLENGTH"){ 
								titleOfParam+=" Не более " + set_dict[i][6] + " символов, без запятых";
							}

							if(set_dict[i][0]=="Umin") valueOfParam = (set[set_dict[12][8]][0]/10-set[set_dict[i][8]][0]/10) + unit;
							else if(set_dict[i][3]=="INT") valueOfParam = set[set_dict[i][8]][0] + unit;
						    else if(set_dict[i][3]=="INT/10") valueOfParam = set[set_dict[i][8]][0]/10 + unit;
						    else if(set_dict[i][3]=="INT/100") valueOfParam = set[set_dict[i][8]][0]/100 + unit;
						    else if(set_dict[i][3]=="STRING") valueOfParam = set[set_dict[i][8]][1];
						    else if(set_dict[i][3]=="SET") valueOfParam = set_dict[i][6][set[set_dict[i][8]][0]];

						    myTable += '<tr>';
						    myTable += '<td title = "' + titleOfParam + '">';
						    myTable += nameOfParam;
						    myTable += "</td>";
						    myTable += '<td class="rightAligned" id = "data'+i+'">';
						   	myTable += valueOfParam;
						    myTable += "</td>";
						    myTable += '<td>';
						    myTable += controlGenerator(i);
						    myTable += "</td>";
						    myTable += "</tr>";
						}
					}
				myTable +=  "</tbody>" ;
				myTable += "</table>" ;

				$("#result").append(myTable) ;
				isPainted=1;
				}
				else {
					for(i=0;i<numOfSets;i++) {
						var idFild="#data"+i;
						if(set_dict[i][3]=="INT") $(idFild).text(set[set_dict[i][8]][0]+set_dict[i][2]);
					    else if(set_dict[i][3]=="INT/10") $(idFild).text(set[set_dict[i][8]][0]/10+set_dict[i][2]);
					    else if(set_dict[i][3]=="INT/100") $(idFild).text(set[set_dict[i][8]][0]/100+set_dict[i][2]);
					    else if(set_dict[i][3]=="STRING") $(idFild).text(palDecoder(set[set_dict[i][8]][1]));
					    else if(set_dict[i][3]=="ONOFF") $(idFild).text(set_dict[i][6][set[set_dict[i][8]][0]]);
					    else if(set_dict[i][3]=="STRING") $(idFild).text(palDecoder(set[set_dict[i][8]][1]));
						
					}
				}
		    }

	      /*var data1 = inputData.abcd ;
	      var data2 = inputData.efgh ;
		  console.log("Данные получены");
		  console.log(data1);
		  console.log(data2);
		  $("#Data1").text(data1);
		  $("#Data2").text(data2);
		  $("#Data3").text(inputData.Uout);*/
	    }
		
		setInterval(dataUpdate,500);
	</script>	
</head>
<body>
<div id="wrap">
	<div id="dev_header">
		<div id="dev_name"> </div>
		<div id="dev_place"> </div>
		<div id="dev_serial"> </div>
	</div>
<!--	<div id="nav">
		<ul>
			<li><a href="http://ruseller.com">Опция 1</a></li>
			<li><a href="http://ruseller.com">Опция 2</a></li>
			<li><a href="http://ruseller.com">Опция 3</a></li>
			<li><a href="http://ruseller.com">Опция 4</a></li>
			<li><a href="http://ruseller.com">Опция 5</a></li>
		</ul>
	</div>-->
	<div id="main">
		<div id= "result"></div>
	</div>
	<div id="sidebar">
		<ul>
			<li><a href="index.htm">Главная</a></li>
			<li><a href="set.html">Установки</a></li>
			<li><a href="log.html">Журнал событий</a></li>
		</ul>
	</div>

</div>
<div id="footer">
	<a class="spa_adress" href="http://vorpostnsk.ru" target="_blank">"Системы промавтоматики"</a>
</div>
</body></html>